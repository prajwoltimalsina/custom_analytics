<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Social Media Campaign Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PapaParse for CSV parsing (fallback if Google Sheets API fails) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- Google API Scripts - Load in correct order -->
    <script
      src="https://apis.google.com/js/api.js"
      onload="gapiLoaded()"
    ></script>
    <script
      src="https://accounts.google.com/gsi/client"
      onload="gisLoaded()"
    ></script>
  </head>
  <body class="bg-gray-100">
    <!-- Alert Box for messages -->
    <div
      id="alertBox"
      style="display: none"
      class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded z-50"
    >
      <span id="alertMessage"></span>
    </div>

    <div class="flex h-screen">
      <!-- Sidebar -->
      <div class="w-64 bg-blue-800 text-white p-5">
        <h2 class="text-3xl font-bold mb-6">Dashboard</h2>

        <ul>
          <li>
            <a href="overview.html" class="block py-2 px-4 hover:bg-blue-700"
              >Overview</a
            >
          </li>
          <li>
            <a href="dashboard.html" class="block py-2 px-4 hover:bg-blue-700"
              >Dashboard</a
            >
          </li>
          <li>
            <a href="#" class="block py-2 px-4 hover:bg-blue-700">Analytics</a>
          </li>
          <li>
            <a href="#" class="block py-2 px-4 hover:bg-blue-700">Settings</a>
          </li>
          <li>
            <a
              href="#"
              id="signOutLink"
              class="block py-2 px-4 hover:bg-blue-700"
              >Logout</a
            >
          </li>
        </ul>
      </div>

      <!-- Main Content -->
      <div class="flex-1 p-6">
        <h1 class="text-3xl font-semibold text-center mb-8 text-blue-800">
          Welcome, <span id="userNameDisplay">User</span> - Social Media
          Campaign Dashboard
        </h1>
        <!-- Metrics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white p-6 rounded-lg shadow-lg">
            <h5 class="text-xl font-semibold mb-2 text-blue-600">
              Engagement Rate
            </h5>
            <h2 id="engagementRate" class="text-4xl font-bold">0%</h2>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-lg">
            <h5 class="text-xl font-semibold mb-2 text-blue-600">
              Follower Growth
            </h5>
            <h2 id="followerGrowth" class="text-4xl font-bold">0</h2>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-lg">
            <h5 class="text-xl font-semibold mb-2 text-blue-600">
              Total Reach
            </h5>
            <h2 id="totalReach" class="text-4xl font-bold">0</h2>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-lg">
            <h5 class="text-xl font-semibold mb-2 text-blue-600">
              Impressions
            </h5>
            <h2 id="impressions" class="text-4xl font-bold">0</h2>
          </div>
        </div>

        <!-- Table for displaying Sheet data -->
        <div class="overflow-x-auto bg-white p-6 rounded-lg shadow-lg mb-8">
          <table class="min-w-full table-auto">
            <thead>
              <tr>
                <th class="py-2 px-4 border-b text-left">Item</th>
                <th class="py-2 px-4 border-b text-left">Value</th>
              </tr>
            </thead>
            <tbody id="campaignTableBody">
              <!-- Data rows will be inserted here -->
            </tbody>
          </table>
        </div>

        <!-- Chart section for visualizing selected data -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
          <h3 class="text-xl font-semibold text-center mb-6 text-blue-600">
            Campaign Performance Metrics
          </h3>
          <div class="max-w-full">
            <canvas id="metricsChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Try to load data via Google Sheets API first (primary method)
        function loadCampaignData() {
          if (typeof gapi !== "undefined" && gapi.client) {
            // Use the fetchCampaignData function from auth.js
            fetchCampaignData(function (results, error) {
              if (error) {
                console.error("Error using Google Sheets API:", error);
                // Fall back to CSV method as backup
                loadCampaignDataFromCSV();
                return;
              }

              if (results && results.length > 0) {
                processCampaignData(results);
              } else {
                showAlert(
                  "No campaign data found. Please check your Google Sheet."
                );
              }
            });
          } else {
            // If Google API isn't loaded yet, use CSV as fallback
            loadCampaignDataFromCSV();
          }
        }

        // Fallback method using published CSV
        function loadCampaignDataFromCSV() {
          const csvUrl =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vShkyha9RUILD6tgutsA9KqriklzAITyydxblmfyYvRvC7lLS60JMsVM3am-8wwu5Kt5a9mHSDvoQgO/pub?output=csv";

          Papa.parse(csvUrl, {
            download: true,
            header: false,
            complete: function (results) {
              if (results.data && results.data.length > 0) {
                processCampaignData(results.data);
              } else {
                showAlert(
                  "Could not load campaign data. Please check your Google Sheet publication settings."
                );
              }
            },
            error: function (error) {
              console.error("Error fetching or parsing the CSV data:", error);
              showAlert(
                "Could not load campaign data. Please try again later."
              );
            },
          });
        }

        // Process the campaign data from either source
        function processCampaignData(data) {
          const tableBody = document.getElementById("campaignTableBody");
          tableBody.innerHTML = ""; // Clear existing data

          const metrics = {};
          let engagementRate = 0;
          let followerGrowth = 0;
          let totalReach = 0;
          let impressions = 0;

          // Process each row of the data
          data.forEach((row, index) => {
            if (index > 0 && row.length >= 2) {
              // Skip header row
              const item = row[0].trim().toLowerCase();
              const value = parseFloat(row[1]) || row[1].trim();

              // Insert rows into the table
              const newRow = tableBody.insertRow();
              const cellItem = newRow.insertCell(0);
              const cellValue = newRow.insertCell(1);
              cellItem.textContent = item;
              cellValue.textContent = value;

              // Collect metrics for the chart and separate values for count-up
              if (item === "engagement rate") {
                engagementRate = parseFloat(value) || 0;
              } else if (item === "follower growth") {
                followerGrowth = parseFloat(value) || 0;
              } else if (item === "total reached" || item === "reach") {
                totalReach = parseFloat(value) || 0;
              } else if (item === "impressions") {
                impressions = parseFloat(value) || 0;
              }

              // Store for chart
              metrics[item] = parseFloat(value) || 0;
            }
          });

          // Update metrics display
          document.getElementById(
            "engagementRate"
          ).textContent = `${engagementRate}%`;
          document.getElementById("followerGrowth").textContent =
            followerGrowth;
          document.getElementById("totalReach").textContent = totalReach;
          document.getElementById("impressions").textContent = impressions;

          // Draw chart
          drawChart(metrics);
        }

        // Display user information
        const user = JSON.parse(localStorage.getItem("user"));
        if (user) {
          document.getElementById("userNameDisplay").textContent =
            user.firstName + " " + user.lastName;
        }

        // Load the campaign data
        // Small delay to ensure Google API is initialized
        setTimeout(loadCampaignData, 1000);
      });

      // Function to draw a chart using Chart.js
      function drawChart(metrics) {
        const ctx = document.getElementById("metricsChart").getContext("2d");

        // Filter out non-numeric values
        const chartMetrics = {};
        Object.entries(metrics).forEach(([key, value]) => {
          if (!isNaN(value) && typeof value === "number") {
            chartMetrics[key] = value;
          }
        });

        new Chart(ctx, {
          type: "bar",
          data: {
            labels: Object.keys(chartMetrics),
            datasets: [
              {
                label: "Campaign Metrics",
                data: Object.values(chartMetrics),
                backgroundColor: "rgba(54, 162, 235, 0.6)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }
    </script>
    <!-- Load auth.js after Google API scripts -->
    <script src="auth.js"></script>
  </body>
</html>
